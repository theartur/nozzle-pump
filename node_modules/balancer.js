var listToSearch;
var possibleFundsPhrase = ["funds.*?:.*?\\d+", "balance.*?:.*?\\d+"];
var possibleRewardsPhrase = ["every.*?\\d+.*?(minute|hour)s?"];
var possibleReferralPhrase = ["referral.*?(http://)"];

var casper = require('casper').create({
    pageSettings: { 
        webSecurityEnabled: false 
    },
    waitTimeout: 60000,
    verbose: false,
//     logLevel: "debug"
});

casper.on('page.resource.requested', function(requestData, request) {
    if (requestData.url.indexOf('about:blank') > -1) {
        request.abort();
    }
    
    if (requestData.url.indexOf('winning.com--congrats.info') > -1) {
        request.abort();
    }
});

var totalReadCount = 0;
var successfulReadCount = 0;
var totalFunds = 0;
var idList = [];

function parseFunds(id, match) {
    var value;
    
    if (match && match.length && match[0]) {
       value = parseInt((''+match[0]).replace(/[^0-9\-]/ig, ''), 10);
    }
    
    idList.push({id:id,value:value});
    
    if (value && value > 0) {
        successfulReadCount++;
        totalFunds += value;
    }
}

var link, BTCtoUSD = 388, USDtoBRL = 3.85;

if (casper.cli.args[0] && casper.cli.args[1]) {
    link = casper.cli.args[0];
    BTCtoUSD = parseFloat(casper.cli.args[1], 10);
} else {
    console.log("INPUT THE FUCKING LINK!!!");
    casper.exit();
}

casper.start(link, function() {
    var self = this;
    
    self.thenOpen(link, function() {
        
        var innerText = this.evaluate(function() {
            return document.body.innerText;
        });
        
        // get funds
        var foundSomething = [], thisMatch;
        for (var i = 0; i < possibleFundsPhrase.length; i++) {
            if (innerText) {
                thisMatch = innerText.match(new RegExp(possibleFundsPhrase[i], 'i'));
            }
            
            if (thisMatch) {
                totalReadCount++;
                parseFunds(link, thisMatch);       

                break;
            } else {
//                 this.echo("NO MATCH FOR " + possibleFundsPhrase[i] + "\n\n\n");
            }
        }
    });
});

casper.run(function() {
    var fundsBTC = (totalFunds / 1e8);
    var fundsUSD = ((totalFunds / 1e8) * BTCtoUSD).toFixed(2);
    var fundsBRL = (((totalFunds / 1e8) * BTCtoUSD) * USDtoBRL).toFixed(2);
    
    var finalBalance = {
        link: link,
        timestamp: (new Date()).toString(),
        BTCtoUSD: BTCtoUSD,
        USDtoBRL: USDtoBRL,
        satoshi: totalFunds,
        fundsBTC: (totalFunds / 1e8),
        fundsUSD: parseFloat(((totalFunds / 1e8) * BTCtoUSD).toFixed(2), 10),
        fundsBRL: parseFloat((((totalFunds / 1e8) * BTCtoUSD) * USDtoBRL).toFixed(2), 10)
    };
    
    this.echo(JSON.stringify(finalBalance));
 
    this.exit();
});