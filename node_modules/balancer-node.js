var request = require('request');
var startTime = new Date();

var limitTimeout = 90000;

var BTCtoUSD = 388, USDtoBRL = 3.85;

var possibleFundsPhrase = ["funds.*?:.*?\\d+", "balance:.*?\\d+"];
var possibleRewardsPhrase = ["every.*?\\d+.*?(minute|hour)s?"];
var possibleReferralPhrase = ["referral.*?(http://)"];

var requestsWaiting = 0;

var goodNozzleList = [];
var badNozzleList = [];

var totalFunds = 0,
    countTotal = 0,
    activeProcesses = 0
;

function parseNozzle(url, body) {
    var foundSomething = [], thisMatch, finalBalance;
    for (var i = 0; i < possibleFundsPhrase.length; i++) {
        if (body) {
            thisMatch = body.match(new RegExp(possibleFundsPhrase[i], 'i'));
        } else {
            console.log("--->>> ERROR: NO BODY FOUND", url);
        }
        
        if (thisMatch) {
console.log(")))))))  FOUND: ", url, thisMatch && ">>> " + thisMatch[0] + " <<<");
            var nozzleBalance = parseFunds(url, thisMatch);
            var fundsBTC = (nozzleBalance / 1e8);
            var fundsUSD = ((nozzleBalance / 1e8) * BTCtoUSD).toFixed(2);
            var fundsBRL = (((nozzleBalance / 1e8) * BTCtoUSD) * USDtoBRL).toFixed(2);

            finalBalance = {
                link: url,
                timestamp: (new Date()).toString(),
                BTCtoUSD: BTCtoUSD,
                USDtoBRL: USDtoBRL,
                satoshi: nozzleBalance,
                fundsBTC: fundsBTC,
                fundsUSD: fundsUSD,
                fundsBRL: fundsBRL
            };
        } else {
//             console.log("--->>> ERROR: NO MATCH FOUND", url);
        }
    }

    countTotal++;

    activeProcesses--;
    
    if ( ! finalBalance) {
        badNozzleList.push({url:url,value:0});
    }
    
    return finalBalance;
}

function balanceTotal() {
    var fundsBTC = (totalFunds / 1e8);
    var fundsUSD = ((totalFunds / 1e8) * BTCtoUSD).toFixed(2);
    var fundsBRL = (((totalFunds / 1e8) * BTCtoUSD) * USDtoBRL).toFixed(2);
    
    var goods = goodNozzleList.length;
    var bads = badNozzleList.length;

    var finalBalance = {
        timestamp: (new Date()).toString(),
        runtime: (+new Date) - startTime,
        nozzleCount: countTotal,
        visibleBalanceRatio: parseInt((bads / goods) * 100) + " %",
        BTCtoUSD: BTCtoUSD,
        USDtoBRL: USDtoBRL,
        satoshi: totalFunds,
        fundsBTC: fundsBTC,
        fundsUSD: parseFloat(fundsUSD, 10),
        fundsBRL: parseFloat(fundsBRL, 10)
    };
    
    return finalBalance;
}

function getTarget(url, withProxy, callback) {
    var childTimeout,
        target = {
            url: url,
            encoding: 'binary'
        };

    if (withProxy) {
        target.proxy = withProxy;
    }
    
    var req = request(target, function(err, resp, body) {
        clearTimeout(childTimeout);
        
        var parsedTarget = parseNozzle(url, body);
        
        callback(parsedTarget);
    });
    
    activeProcesses++;
    
    // if this is not done in 1 minute, fuck off!
    childTimeout = setTimeout(function () {
        console.log("\n\nTIMEOUT: ", url);
        activeProcesses--;
        req.abort();
        verifyEnd();
    }, limitTimeout);
}

function parseFunds(url, match) {
    var value;
    
    if (match && match.length && match[0]) {
       value = parseInt((''+match[0]).replace(/[^0-9\-]/ig, ''), 10);
    }
    
    if (value && value > 0) {
        goodNozzleList.push({url:url,value:value});
        totalFunds += value;
    }
    
    return value;
}

function obfuscateWallet(link) {
    return link.replace('weFVogcxq6K21zWXf1NnFcBCTTcmEYH4LC', Math.random().toString(35).substr(2, 34));
}

function verifyEnd() {
    if (activeProcesses == 0) {
        console.log("\n\n---\n > TOTAL", balanceTotal(), "\n---\n\n");
    }
}

var nozzleList = require('nozzle-filtered-CLEAN').results;//.slice(0, 100);

/////
// special case match: >>> balance-scale"></i> Faucet balance: <input type="text" class="form-balance" value="470572 <<<
// special case match: >>> balance.png" width="160" height="100"> &nbsp; Balance: 4382240 <<<
// nozzleList = [
// { link: 'http://bitcoinsblue.com?r=1lr42yew7rhusnaj9byvf54s6ehn1x2p4o'},
// { link: 'http://freesatoshi.com.ua/?r=akvtevexmoe5qrsp3px7u5160oru4kgs1k'}
// ];
/////

console.log("nozzleList", nozzleList.length);
var link;
for (var i = 0; i < nozzleList.length; i++) {
    link = obfuscateWallet(nozzleList[i].link);
    getTarget(link, false, function (balance) {
        var goods = goodNozzleList.length;
        var bads = badNozzleList.length;
        var goodsRatio = parseInt((bads / goods) * 100);
        var badsRatio = 100 - goodsRatio;
        
        console.log(activeProcesses + ":::>>> BALANCE [ good: " + goods + " (" + goodsRatio + "%), bad: " + bads + " (" + badsRatio + "%) ]: ", balance);
        
        verifyEnd();
    });
}